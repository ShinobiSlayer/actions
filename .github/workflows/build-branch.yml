name: Build and Push Docker Image

on:
  push:
    branches:
      - 'main'
      - 'dev'
      - 'test'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      DOCKER_BUILDKIT: 1
      BUILDKIT_PROGRESS: plain

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Verify Java Installation
        run: java -version

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Calculate Version
        id: version
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -e

          # Get current year and month
          YEAR=$(date +%Y)
          MONTH=$(date +%m)

          # Get first day of current month for git log filtering
          MONTH_START="${YEAR}-${MONTH}-01"

          # Count commits in current month on this branch
          # Fetch full history first
          git fetch --unshallow 2>/dev/null || git fetch --depth=1000

          # Count commits this month
          BUILD_NUM=$(git log --since="${MONTH_START}" --oneline --no-merges | wc -l | tr -d ' ')

          # Ensure it's at least 001
          if [ "$BUILD_NUM" -eq 0 ]; then
            BUILD_NUM=1
          fi

          # Format as 3 digits
          BUILD_NUM=$(printf "%03d" $BUILD_NUM)

          # Determine branch suffix
          BRANCH_UPPER=$(echo "$BRANCH_NAME" | tr '[:lower:]' '[:upper:]')

          # Construct version: YYYY.MM.NNN-BRANCH
          VERSION="${YEAR}.${MONTH}.${BUILD_NUM}-${BRANCH_UPPER}"

          echo "======================================"
          echo "Calculated Version: $VERSION"
          echo "Year: $YEAR, Month: $MONTH, Build: $BUILD_NUM"
          echo "======================================"

          # Export for later steps
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "YEAR=$YEAR" >> $GITHUB_OUTPUT
          echo "MONTH=$MONTH" >> $GITHUB_OUTPUT
          echo "BUILD_NUM=$BUILD_NUM" >> $GITHUB_OUTPUT
          echo "BRANCH_UPPER=$BRANCH_UPPER" >> $GITHUB_OUTPUT

      - name: Update Build Configuration
        run: |
          # Update build.gradle.kts with the calculated version
          sed -i 's/val codeVersion = ".*"/val codeVersion = "${{ steps.version.outputs.YEAR }}.${{ steps.version.outputs.MONTH }}.${{ steps.version.outputs.BUILD_NUM }}"/' build.gradle.kts

          echo "Updated build.gradle.kts with version: ${{ steps.version.outputs.VERSION }}"

      - name: Make Gradlew Executable
        run: chmod +x ./gradlew

      - name: Build and Push Docker Image
        run: |
          set -e
          echo "======================================"
          echo "Building version: ${{ steps.version.outputs.VERSION }}"
          echo "======================================"

          # Build and push Docker image with versioned tag
          ./gradlew -PbranchVersion=${{ steps.version.outputs.BRANCH_UPPER }} clean build docker

          echo "======================================"
          echo "Build complete!"
          echo "Docker image: shinobislayer/actions:${{ steps.version.outputs.VERSION }}"
          echo "Docker image: shinobislayer/actions:latest"
          echo "======================================"

      - name: Create Git Tag
        if: success()
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create annotated tag
          git tag -a "v${{ steps.version.outputs.VERSION }}" -m "Release ${{ steps.version.outputs.VERSION }}"

          # Push tag
          git push origin "v${{ steps.version.outputs.VERSION }}"

          echo "======================================"
          echo "Created and pushed tag: v${{ steps.version.outputs.VERSION }}"
          echo "======================================"

      - name: Update Deployment Repo
        if: success()
        run: |
          echo "======================================"
          echo "Updating deployment repository with version: ${{ steps.version.outputs.VERSION }}"
          echo "======================================"

          # Clone deployment repo
          git clone https://x-access-token:${{ secrets.DEPLOYMENT_REPO_TOKEN }}@github.com/ShinobiSlayer/actions-deployment.git /tmp/deployment

          cd /tmp/deployment

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Update dev environment with new version
          sed -i "s/newTag: .*/newTag: ${{ steps.version.outputs.VERSION }}/" environments/dev/kustomization.yaml

          # Commit and push
          git add environments/dev/kustomization.yaml
          git commit -m "Deploy version ${{ steps.version.outputs.VERSION }} to dev [automated]"
          git push origin main

          echo "======================================"
          echo "Deployment repo updated successfully!"
          echo "======================================"

      - name: Trigger ArgoCD Sync via Webhook
        if: success()
        run: |
          echo "======================================"
          echo "Triggering ArgoCD refresh for actions-dev"
          echo "======================================"

          # Trigger ArgoCD refresh webhook (this forces ArgoCD to check for changes immediately)
          curl -X POST "${{ secrets.ARGOCD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"ref": "refs/heads/main", "repository": {"full_name": "ShinobiSlayer/actions-deployment"}}' || echo "Webhook trigger failed, ArgoCD will auto-sync within 3 minutes"

          echo "======================================"
          echo "ArgoCD refresh triggered! Sync will happen automatically."
          echo "======================================"

      - name: Summary
        if: success()
        run: |
          echo "======================================"
          echo "âœ… Build and Deployment Complete!"
          echo "======================================"
          echo "Version: ${{ steps.version.outputs.VERSION }}"
          echo "Git Tag: v${{ steps.version.outputs.VERSION }}"
          echo "Docker Image: shinobislayer/actions:${{ steps.version.outputs.VERSION }}"
          echo ""
          echo "Deployment repo updated: environments/dev/kustomization.yaml"
          echo "ArgoCD will sync the change automatically."
          echo ""
          echo "Monitor at: https://argocd.example.com"
          echo "======================================"

